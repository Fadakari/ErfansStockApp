{% extends "base.html" %}

{% block content %}
<style>
    .spinner {
      width: 32px;
      height: 32px;
      border: 4px solid #ccc;
      border-top: 4px solid var(--light-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      background: transparent;
      position: fixed;
      top: -60px;   /* اول پایین صفحه، پنهان */
      left: 80%;
      transform: translateX(-80%);
      transition: top 0.3s ease;
      z-index: 10000;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    </style>
    <div id="pull-spinner" style="position: fixed; top: -60px; left: 50%; transform: translateX(-50%); z-index: 9999; transition: top 0.3s;">
        <div class="spinner"></div>
      </div>
<div class="container mt-4" id="page-content" class="page-transition">
    <div class="row">
        <div class="py-2 px-3">
           <button class="btn header-tabs py-2 px-3 float-start" onclick="history.back()">
            <i class="bi bi-arrow-left fs-3 txt-black"></i>
        </button><br>
        </div>
        <div class="col-lg-4 col-md-6">
            {% if product.image_path %}
            <img src="{{ url_for('static', filename='uploads/' + product.image_path) }}"
                class="img-fluid img-clickable"
                data-bs-toggle="modal"
                data-bs-target="#imageModal"
                data-img-src="{{ url_for('static', filename='uploads/' + product.image_path) }}"
                alt="{{ product.name }}"
                style="cursor: pointer;">
            {% endif %}
        </div>
        
        <div class="col-md-6 mb-5 mt-4">
            <h2 class="txt-black">{{ product.name }}</h2>
            {% if product.price == product.price|int %}
                <h3 class="mb-4 txt-black">قیمت: {{ "{:,}".format(product.price | int) }} تومان</h3>
            {% else %}
                <h3 class="mb-4 txt-black">قیمت: {{ "{:,.2f}".format(product.price) }} تومان</h3>
            {% endif %}
            <p class="text-muted txt-black">فروشنده: {{ product.owner.username }}</p>
            
            {% if product.address %}
                <p class="txt-black"><strong>آدرس:</strong> {{ product.address }}</p>
            {% else %}
                <p>آدرس وارد نشده است</p>
            {% endif %}
            {% if user.phone %}
                <div class="d-flex flex-nowrap justify-content-start align-items-center my-3 txt-black"><strong class="m-0">شماره تلفن:</strong><p onclick="copyText(this)" class="header-tabs py-2 px-3 w-75 m-0">{{ user.phone }}</p></div>
            {% else %}
                <p>شماره تلفن وارد نشده است</p>
            {% endif %}
            <div class="mb-3">
                <p class="txt-black"><strong class="ps-2">برند:</strong> {{ product.brand or "نامشخص" }}</p>
            </div>
            {% if product.product_type %}
                <p class="txt-black"><strong>نوع محصول:</strong> {{ product.product_type.value }}</p>
            {% else %}
                <p>نوع محصول وارد نشده است</p>
            {% endif %}

            <!-- {% if current_user.id != product.owner.id %}
                <a href="{{ url_for('main.start_conversation', user_id=product.owner.id) }}" class="btn btn-primary mt-3">
                    چت با فروشنده
                </a>
            {% endif %} -->
            <hr class="w-100 txt-black">
            <p>توضیحات و ویژگی ها:</p>
            <p class="lead txt-black preserve-format" style="white-space: pre-wrap!important;">{{ product.description }}</p>
            <hr class="w-100 txt-black">
            <p class="txt-black">تاریخ انتشار: {{ product.updated_at }}</p>

            <div class="mt-4">
                <button class="btn btn-danger" onclick="document.getElementById('reportForm').classList.toggle('d-none')">
                    گزارش تخلف
                </button>
                <form id="reportForm" class="mt-3 d-none" method="POST" action="{{ url_for('main.report_violation', product_id=product.id) }}">
                    <textarea name="report_text" class="form-control mb-2" rows="4" placeholder="شرح تخلف را وارد کنید..." required></textarea>
                    <button type="submit" class="btn btn-warning">ارسال گزارش</button>
                </form>
            </div>
        </div>
        
    </div>
</div>
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">  <!-- modal-lg برای بزرگتر شدن -->
      <div class="modal-content" style="background: var(--black-color);">
        <div class="modal-header">
          <h5 class="modal-title txt-black" id="imageModalLabel"></h5>
          <button type="button" class="btn-close txt-black" data-bs-dismiss="modal" aria-label="بستن"></button>
        </div>
        <div class="modal-body d-flex justify-content-center">
          <img id="modalImage" src="" alt="تصویر بزرگ" style="max-width: 100%; height: auto;">
        </div>
      </div>
    </div>
  </div>
<script>
    function copyText(element) {
            const text = element.innerText || element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                let toast = document.createElement("span");
                toast.classList.add("toast-message");
                toast.innerText = "متن با موفقیت کپی شد!";
                
                document.body.appendChild(toast);

                // نمایش پیام
                setTimeout(() => {
                    toast.classList.add("show");
                }, 10);

                // حذف پیام بعد از 2 ثانیه
                setTimeout(() => {
                    toast.classList.remove("show");
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 2000);
            }).catch(err => {
                console.error("خطا در کپی کردن متن:", err);
            });
        }
</script>
<script>
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;
    const threshold = 80; // حداقل فاصله افقی برای تغییر صفحه
    const minHorizontalMove = 30; // حداقل اختلاف افقی برای فعال شدن سوایپ
    const maxVerticalMove = 50;   // حداکثر اختلاف عمودی که اجازه سوایپ رو میده
    let page = document.getElementById("page-content");

    window.addEventListener("touchstart", (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        page.style.transition = "none"; // لغو انیمیشن برای حرکت زنده
    });

    window.addEventListener("touchmove", (e) => {
        currentX = e.touches[0].clientX;
        currentY = e.touches[0].clientY;
        let diffX = currentX - startX;
        let diffY = currentY - startY;

        // فقط اگر حرکت افقی بیشتر از حداقل بود و حرکت عمودی کمتر از حداکثر، اجازه حرکت بده
        if (Math.abs(diffX) > minHorizontalMove && Math.abs(diffY) < maxVerticalMove) {
            page.style.transform = `translateX(${diffX}px)`;
        }
    });

    window.addEventListener("touchend", () => {
        let diffX = currentX - startX;
        let diffY = currentY - startY;

        page.style.transition = "transform 0.3s ease"; // بازگرداندن انیمیشن

        // فقط اگر حرکت افقی بزرگتر از آستانه و حرکت عمودی کمتر از حد بود، صفحه رو جابجا کن
        if (Math.abs(diffX) > threshold && Math.abs(diffY) < maxVerticalMove) {
            if (diffX > 0) {
                // سوایپ به راست ← رفتن به صفحه قبلی
                page.style.transform = "translateX(100%)";
                setTimeout(() => {
                    window.location.href = "https://stockdivar.ir"; // مسیر مد نظر شما
                }, 300);
            } else {
                // سوایپ به چپ → رفتن به صفحه بعدی
                page.style.transform = "translateX(-100%)";
                setTimeout(() => {
                    window.location.href = "https://stockdivar.ir"; // مسیر مد نظر شما
                }, 300);
            }
        } else {
            // برگرداندن صفحه به جای قبلی
            page.style.transform = "translateX(0)";
        }

        startX = 0;
        currentX = 0;
        startY = 0;
        currentY = 0;
    });

</script>
<script>
    document.querySelectorAll('.img-clickable').forEach(img => {
        img.addEventListener('click', function () {
            const modalImage = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');

            modalImage.src = this.getAttribute('data-img-src');

            // چون این تصویر توضیح نداره، caption رو خالی می‌کنیم
            modalCaption.textContent = this.getAttribute('data-caption') || '';
        });
    });
</script>
<script>
    let startedY = 0;
    let isPulling = false;
    let spinner = document.getElementById("pull-spinner");
    
    window.addEventListener("touchstart", function (e) {
        if (window.scrollY === 0) {
            startedY = e.touches[0].clientY;
            isPulling = true;
        }
    });
    
    window.addEventListener("touchmove", function (e) {
        if (!isPulling) return;
    
        let currentY = e.touches[0].clientY;
        let diffY = currentY - startedY;
    
        if (diffY > 30 && diffY < 130) {
            spinner.style.top = `${diffY - 60}px`; // اسپینر پایین‌تر نمایش داده می‌شود
        }
    
        if (diffY >= 130) {
            spinner.style.top = `150px`; // اسپینر در پایین نمایان می‌ماند
            if (!spinner.dataset.loading) {  // جلوگیری از چندبار اجرا شدن رفرش
                spinner.dataset.loading = "true";
                location.reload(); // رفرش صفحه
            }
            isPulling = false;
        }
    });
    
    window.addEventListener("touchend", function () {
        // اگر رفرش کامل نشده بود اسپینر رو پنهان کن
        if (!spinner.dataset.loading) {
            spinner.style.top = `-60px`; 
        }
        isPulling = false;
    });
    
    // رویداد بارگذاری کامل صفحه
    window.addEventListener("load", function () {
        // وقتی صفحه کاملا لود شد، اسپینر رو پنهان کن بالا
        spinner.style.top = `-60px`; 
        spinner.dataset.loading = ""; // ریست کردن وضعیت لودینگ
    });
    </script>
{% endblock %}
