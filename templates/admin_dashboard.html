{% extends "base.html" %}

{% block content %}
<button class="btn header-tabs py-2 px-3 float-start">
    <a href="{{ url_for('main.index') }}">
        <i class="bi bi-arrow-left fs-3 txt-black"></i>
    </a>
</button>
<h2 class="txt-black">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
<hr class="w-100">
<h3>ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù¾Ù„ØªÙØ±Ù…: {{ count*2 }}</h3>
<h3>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†: <span id="userCount">...</span></h3>
<h3>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {{ total_users*2 }}</h3>
<hr class="w-100">
 <script>
        function fetchOnlineUsers() {
            fetch('/online-users')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('userCount').innerText = data.count;
                });
        }

        fetchOnlineUsers();              // Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±
        setInterval(fetchOnlineUsers, 1000);  // Ù‡Ø± Û± Ø«Ø§Ù†ÛŒÙ‡
    </script>



<h3 class="txt-black mt-5 mb-5">Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</h3>
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-2 row-cols-xl-3 g-4 prod mb-5">
    {% for product in pending_products %}
    <div class="col">
        <div class="card productes h-100 header-tabs text-light">
            {% if product.image_path %}
            <img src="{{ url_for('static', filename='uploads/' + product.image_path) }}" class="card-img-top" alt="{{ product.name }}">
            {% endif %}
            <div class="card-body">
                <h5 class="card-title txt-black">{{ product.name }}</h5>
                <p class="card-text description px-2">{{ product.description }}</p>
                {% if product.address %}
                    <p class="txt-black">{{ product.address }}</p>
                {% endif %}
                <p class="card-text txt-black"><strong>{{ "{:,}".format(product.price | int) }} ØªÙˆÙ…Ø§Ù†</strong></p>
                <p class="txt-black">Ú©Ø§Ø±Ø¨Ø±: {{ users_dict[product.user_id] }}</p>
                <p class="txt-black">Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡: {{ product.created_at.strftime('%Y-%m-%d %H:%M') }}</p>

                <form method="POST" action="{{ url_for('main.approve_product', product_id=product.id) }}">
                    <button type="submit" class="btn btn-success w-100 mt-2">âœ”ï¸ ØªØ£ÛŒÛŒØ¯ Ù…Ø­ØµÙˆÙ„</button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<hr class="w-100">




<h3 class="txt-black">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ØªØ®Ù„Ù</h3>
<div class="table-responsive">
    <table class="table bg-black rounded-3 mb-5">
        <thead>
            <tr>
                <th class="text-end">Ú©Ø§Ø±Ø¨Ø± Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡Ù†Ø¯Ù‡</th>
                <th class="text-end">Ù…Ø­ØµÙˆÙ„</th>
                <th class="text-end">Ø´Ø±Ø­ Ú¯Ø²Ø§Ø±Ø´</th>
                <th class="text-end">ØªØ§Ø±ÛŒØ®</th>
            </tr>
        </thead>
        <tbody class="bg-very-black">
            {% for report in reports %}
            <tr>
                <td>{{ report.reporter.username }}</td>
                <td><a href="{{ url_for('main.product_detail', product_id=report.product.id) }}" target="_blank">{{ report.product.name }}</a></td>
                <td>{{ report.text }}</td>
                <td>{{ report.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <form action="{{ url_for('main.delete_report', report_id=report.id) }}" method="post" onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ');">
                      <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ Ø­Ø°Ù</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>



<h3 class="txt-black">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
<form method="GET" action="{{ url_for('main.admin_dashboard') }}" class="d-flex flex-wrap gap-2 mb-3">
    <input type="text" name="query" class="inputs flex-grow-1" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...">
    <select name="role_filter" class="form-select txt-black">
        <option class="txt-black" value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>
        <option class="txt-black" value="admin">ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§</option>
        <option class="txt-black" value="user">ÙÙ‚Ø· Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ</option>
    </select>
    <button type="submit" class="btn btn-primary">Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ</button>
</form>

<div class="table-responsive">
    <table class="table bg-black rounded-3 mb-5">
        <thead class="bg-black">
            <tr>
                <th class="text-end">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
                <th class="text-end">Ø§ÛŒÙ…ÛŒÙ„</th>
                <th class="text-end">Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</th>
                <th class="text-end">Ú©Ø¯ Ù…Ù„ÛŒ</th>
                <th class="text-end">Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†</th>
                <th class="text-end">Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
        </thead>
        <tbody class="bg-very-black">
            {% for user in users %}
            <tr>
                <td style="cursor: pointer;" onclick="copyText(this)">{{ user.username }}</td>
                <td style="cursor: pointer;" onclick="copyText(this)">{{ user.email }}</td>
                <td style="cursor: pointer;" onclick="copyText(this)">{{ user.phone }}</td>
                <td style="cursor: pointer;" onclick="copyText(this)">{{ user.national_id }}</td>
                <td style="cursor: pointer;" onclick="copyText(this)">{{ "Ø§Ø¯Ù…ÛŒÙ†" if user.is_admin else "Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ" }}</td>
                <td class="d-flex flex-wrap gap-2" style="cursor: pointer;">
                    <a href="{{ url_for('main.user_dashboard', user_id=user.id) }}" class="btn btn-info">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
                
                    {% if not user.is_admin %}
                        <form action="{{ url_for('main.make_admin', user_id=user.id) }}" method="POST">
                            <button type="submit" class="btn btn-primary">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø¯Ù…ÛŒÙ†</button>
                        </form>
                    {% else %}
                        <form action="{{ url_for('main.remove_admin', user_id=user.id) }}" method="POST">
                            <button type="submit" class="btn btn-warning" onclick="return confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ø² Ø§Ø¯Ù…ÛŒÙ†ÛŒ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')">Ø­Ø°Ù Ø§Ø¯Ù…ÛŒÙ†</button>
                        </form>
                    {% endif %}
                    
                    <form action="{{ url_for('main.delete_user', user_id=user.id) }}" method="POST">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')">Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±</button>
                    </form>
                </td>
            </tr>
            {% endfor %}

        </tbody>
    </table>
</div>



<div class="text-center my-4">
    <button class="btn btn-danger" onclick="cleanupUnusedImages()">ğŸ§¹ Ø­Ø°Ù ØªØµØ§ÙˆÛŒØ± Ø¨Ù„Ø§Ø§Ø³ØªÙØ§Ø¯Ù‡</button>
</div>



<script>
function cleanupUnusedImages() {
    if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØµØ§ÙˆÛŒØ± Ø¨Ù„Ø§Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ")) return;

    fetch('/admin/cleanup-images', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
    })
    .catch(err => {
        alert("Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø­Ø°Ù ØªØµØ§ÙˆÛŒØ± Ø±Ø® Ø¯Ø§Ø¯");
        console.error(err);
    });
}
</script>

<!-- <h3>Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
<form action="{{ url_for('main.add_category') }}" method="POST" class="d-flex flex-wrap gap-2">
    <input type="text" name="category_name" class="inputs flex-grow-1" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯" required>
    <button type="submit" class="btn btn-success">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
</form>

<h3>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h3>
<div class="table-responsive" style="margin-bottom: 6rem;">
    <table class="table">
        <thead>
            <tr>
                <th>Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
        </thead>
        <tbody>
            {% for category in categories %}
            <tr>
                <td>{{ category.name }}</td>
                <td>
                    <form action="{{ url_for('main.delete_category', category_id=category.id) }}" method="POST">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')">Ø­Ø°Ù Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div> -->

<script>
    function copyText(element) {
        const text = element.innerText || element.textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert("Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯!");
        }).catch(err => {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†:", err);
        });
    }
</script>
{% endblock %}