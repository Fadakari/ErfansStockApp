<!DOCTYPE html>
<html lang="fa" data-bs-theme="dark" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}استوک{% endblock %}</title>

    <!-- PWA Meta -->
    <meta name="theme-color" content="#9B1B30">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/Icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Scripts -->
    <script src="/static/js/theme.js" defer></script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    <script>
        var citiesByProvince = {
            "آذربایجان شرقی": [
                "تبریز",
                "اسکو",
                "اهر",
                "بستان‌آباد",
                "بناب",
                "جلفا",
                "چاراویماق",
                "خداآفرین",
                "سراب",
                "شبستر",
                "عجب‌شیر",
                "کلیبر",
                "مراغه",
                "مرند",
                "ملکان",
                "میانه",
                "ورزقان",
                "هریس",
                "هشترود"
            ],
            "آذربایجان غربی": [
                "ارومیه",
                "اشنویه",
                "بوکان",
                "پلدشت",
                "پیرانشهر",
                "تکاب",
                "چالدران",
                "چایپاره",
                "خوی",
                "سردشت",
                "سلماس",
                "شاهین‌دژ",
                "شوط",
                "ماکو",
                "مهاباد",
                "میاندوآب",
                "نقده"
            ],
            "اردبیل": [
                "اردبیل",
                "بیله‌سوار",
                "پارس‌آباد",
                "خلخال",
                "سرعین",
                "کوثر",
                "گرمی",
                "مشگین‌شهر",
                "نمین",
                "نیر"
            ],
            "اصفهان": [
                "اصفهان",
                "آران و بیدگل",
                "اردستان",
                "برخوار",
                "بوئین و میاندشت",
                "تیران و کرون",
                "چادگان",
                "خمینی‌شهر",
                "خوانسار",
                "خور و بیابانک",
                "دهاقان",
                "سمیرم",
                "شاهین‌شهر و میمه",
                "شهرضا",
                "فریدن",
                "فریدون‌شهر",
                "فلاورجان",
                "کاشان",
                "گلپایگان",
                "لنجان",
                "مبارکه",
                "نائین",
                "نجف‌آباد",
                "نطنز"
            ],
            "البرز": [
                "کرج",
                "اشتهارد",
                "ساوجبلاغ",
                "طالقان",
                "فردیس",
                "نظرآباد"
            ],
            "ایلام": [
                "ایلام",
                "آبدانان",
                "ایوان",
                "بدره",
                "چرداول",
                "دره‌شهر",
                "دهلران",
                "سیروان",
                "ملکشاهی",
                "مهران"
            ],
            "بوشهر": [
                "بوشهر",
                "تنگستان",
                "جم",
                "دشتستان",
                "دشتی",
                "دیر",
                "دیلم",
                "کنگان",
                "گناوه"
            ],
            "تهران": [
                "تهران",
                "اسلامشهر",
                "بهارستان",
                "پاکدشت",
                "پردیس",
                "پیشوا",
                "دماوند",
                "رباط‌کریم",
                "ری",
                "شمیرانات",
                "شهریار",
                "فیروزکوه",
                "قدس",
                "قرچک",
                "ملارد",
                "ورامین"
            ],
            "چهارمحال و بختیاری": [
                "شهرکرد",
                "اردل",
                "بروجن",
                "بن",
                "سامان",
                "فارسان",
                "کوهرنگ",
                "کیار",
                "لردگان"
            ],
            "خراسان جنوبی": [
                "بیرجند",
                "بشرویه",
                "خوسف",
                "درمیان",
                "زیرکوه",
                "سرایان",
                "سربیشه",
                "طبس",
                "فردوس",
                "قائنات",
                "نهبندان"
            ],
            "خراسان رضوی": [
                "مشهد",
                "بردسکن",
                "بجستان",
                "تایباد",
                "تربت جام",
                "تربت حیدریه",
                "چناران",
                "خلیل‌آباد",
                "خواف",
                "درگز",
                "رشتخوار",
                "زاوه",
                "سبزوار",
                "سرخس",
                "فریمان",
                "قوچان",
                "کاشمر",
                "کلات",
                "گناباد",
                "مه‌ولات",
                "نیشابور"
            ],
            "خراسان شمالی": [
                "بجنورد",
                "اسفراین",
                "جاجرم",
                "راز و جرگلان",
                "شیروان",
                "فاروج",
                "گرمه",
                "مانه و سملقان"
            ],
            "خوزستان": [
                "اهواز",
                "آبادان",
                "امیدیه",
                "اندیکا",
                "اندیمشک",
                "ایذه",
                "باغ‌ملک",
                "باوی",
                "بهبهان",
                "حمیدیه",
                "خرمشهر",
                "دزفول",
                "دشت آزادگان",
                "رامشیر",
                "رامهرمز",
                "شادگان",
                "شوش",
                "شوشتر",
                "کارون",
                "گتوند",
                "لالی",
                "ماهشهر",
                "مسجدسلیمان",
                "هفتکل",
                "هندیجان",
                "هویزه"
            ],
            "زنجان": [
                "زنجان",
                "ابهر",
                "ایجرود",
                "خدابنده",
                "خرمدره",
                "سلطانیه",
                "طارم",
                "ماهنشان"
            ],
            "سمنان": [
                "سمنان",
                "دامغان",
                "سرخه",
                "شاهرود",
                "گرمسار",
                "مهدی‌شهر",
                "میامی"
            ],
            "سیستان و بلوچستان": [
                "زاهدان",
                "ایرانشهر",
                "چابهار",
                "خاش",
                "دلگان",
                "زابل",
                "زهک",
                "سراوان",
                "سرباز",
                "سیب و سوران",
                "فنوج",
                "قصرقند",
                "کنارک",
                "مهرستان",
                "میرجاوه",
                "نیک‌شهر"
            ],
            "فارس": [
                "شیراز",
                "آباده",
                "ارسنجان",
                "استهبان",
                "اقلید",
                "بوانات",
                "پاسارگاد",
                "جهرم",
                "خرامه",
                "خنج",
                "داراب",
                "زرین‌دشت",
                "سروستان",
                "سپیدان",
                "شیراز",
                "فراشبند",
                "فسا",
                "فیروزآباد",
                "قایمیه",
                "قیر و کارزین",
                "کازرون",
                "گراش",
                "لارستان",
                "لامرد",
                "مرودشت",
                "ممسنی",
                "نی‌ریز"
            ],
            "قزوین": [
                "قزوین",
                "آبیک",
                "البرز",
                "بوئین‌زهرا",
                "تاکستان",
                "آوج"
            ],
            "قم": [
                "قم"
            ],
            "کردستان": [
                "سنندج",
                "بانه",
                "بیجار",
                "دیواندره",
                "دهگلان",
                "سروآباد",
                "سقز",
                "قروه",
                "کامیاران",
                "مریوان"
            ],
            "کرمان": [
                "کرمان",
                "ارزوئیه",
                "انار",
                "بافت",
                "بردسیر",
                "بم",
                "جیرفت",
                "رابر",
                "راور",
                "رودبار جنوب",
                "ریگان",
                "زرند",
                "سیرجان",
                "شهربابک",
                "عنبرآباد",
                "فاریاب",
                "فهرج",
                "قلعه گنج",
                "کوهبنان",
                "کهنوج",
                "منوجان"
            ],
            "کرمانشاه": [
                "کرمانشاه",
                "اسلام‌آباد غرب",
                "پاوه",
                "ثلاث باباجانی",
                "جوانرود",
                "دالاهو",
                "روانسر",
                "سرپل ذهاب",
                "سنقر",
                "صحنه",
                "قصر شیرین",
                "کرند غرب",
                "کنگاور",
                "گیلانغرب",
                "هرسین"
            ],
            "کهگیلویه و بویراحمد": [
                "یاسوج",
                "باشت",
                "بویراحمد",
                "بهمئی",
                "چرام",
                "دنا",
                "کهگیلویه",
                "گچساران",
                "لنده"
            ],
            "گلستان": [
                "گرگان",
                "آزادشهر",
                "آق‌قلا",
                "بندر گز",
                "ترکمن",
                "رامیان",
                "علی‌آباد کتول",
                "کردکوی",
                "کلاله",
                "گالیکش",
                "گمیشان",
                "گنبد کاووس",
                "مراوه‌تپه",
                "مینودشت"
            ],
            "گیلان": [
                "رشت",
                "آستارا",
                "آستانه اشرفیه",
                "املش",
                "بندر انزلی",
                "تالش",
                "رودبار",
                "رودسر",
                "رضوانشهر",
                "سیاهکل",
                "شفت",
                "صومعه‌سرا",
                "فومن",
                "لاهیجان",
                "لنگرود",
                "ماسال"
            ],
            "لرستان": [
                "خرم‌آباد",
                "الیگودرز",
                "بروجرد",
                "پل‌دختر",
                "چگنی",
                "دلفان",
                "دورود",
                "رومشکان",
                "سلسله",
                "کوهدشت"
            ],
            "مازندران": [
                "ساری",
                "آمل",
                "بابل",
                "بابلسر",
                "بهشهر",
                "تنکابن",
                "جویبار",
                "چالوس",
                "رامسر",
                "سوادکوه",
                "عباس‌آباد",
                "فریدون‌کنار",
                "قائم‌شهر",
                "کلاردشت",
                "گلوگاه",
                "محمودآباد",
                "میاندرود",
                "نکا",
                "نور",
                "نوشهر"
            ],
            "مرکزی": [
                "اراک",
                "آشتیان",
                "تفرش",
                "خمین",
                "دلیجان",
                "زرندیه",
                "ساوه",
                "شازند",
                "کمیجان",
                "محلات"
            ],
            "هرمزگان": [
                "بندرعباس",
                "ابوموسی",
                "بستک",
                "بشاگرد",
                "بندر لنگه",
                "پارسیان",
                "جاسک",
                "حاجی‌آباد",
                "خمیر",
                "رودان",
                "سیریک",
                "قشم",
                "میناب"
            ],
            "همدان": [
                "همدان",
                "اسدآباد",
                "بهار",
                "تویسرکان",
                "رزن",
                "کبودرآهنگ",
                "ملایر",
                "نهاوند"
            ],
            "یزد": [
                "یزد",
                "ابرکوه",
                "اردکان",
                "اشکذر",
                "بافق",
                "بهاباد",
                "تفت",
                "خاتم",
                "مهریز",
                "میبد"
            ]
        };
    </script>
    <style>
        .spinner {
          width: 32px;
          height: 32px;
          border: 4px solid #ccc;
          border-top: 4px solid var(--light-green);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          background: transparent;
          position: fixed;
          top: -60px;   /* اول پایین صفحه، پنهان */
          left: 80%;
          transform: translateX(-80%);
          transition: top 0.3s ease;
          z-index: 10000;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .bottom-nav {
            background-color: var(--black-color);
            width: 100%;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -0.5rem 2rem var(--light-green);
            padding: 0 0 0 1rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1030;
        }

        .bottom-nav .nav-item {
            flex-grow: 1;
        }
        .custom-icon {
            width: 48px; /* اندازه را برای نمایش بهتر جزئیات، بزرگتر انتخاب کنید */
            height: 48px;
            color: var(--text-color); /* رنگ اصلی آیکون با تم شما هماهنگ می‌شود */
        }
        
        /* این بخش برای ایجاد افکت دو-رنگ است */
        .custom-icon .primary-part {
            fill: currentColor;
            opacity: 1; /* بخش اصلی با رنگ کامل */
        }
        
        .custom-icon .secondary-part {
            fill: currentColor;
            opacity: 0.6; /* بخش دوم با شفافیت، برای ایجاد عمق */
        }

        .bottom-nav .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
        }
        
        .bottom-nav .nav-link i {
            font-size: 1rem;
            margin-bottom: 4px;
        }
        .fab-container {
            position: relative;
            width: 70px; /* Container to hold the button */
            display: flex;
            justify-content: center;
        }
        
        .fab {
            background-color: var(--light-green);
            color: var(--white-color);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: absolute;
            bottom: 15px; /* Lifts the button up */
            transition: all 0.3s ease;
        }
        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            color: var(--white-color);
        }
        .category-icon {
            width: 32px;  /* اندازه دلخواه */
            height: 32px; /* اندازه دلخواه */
            color: var(--text-color); /* رنگ آیکون با تم شما هماهنگ می‌شود */
            stroke-width: 1.5; /* ضخامت خطوط در آیکون‌های outline */
        }
        .select2-container--default .select2-selection--single {
            height: 38px;
            background-color: var(--dark-green);
            border: 1px solid var(--dark-green);
            border-radius: 0.375rem;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
            padding-left: 12px;
            background-color: var(--dark-green);
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
            background-color: var(--dark-green);
        }
        .select2-results__option {
            padding: 6px;
            user-select: none;
            -webkit-user-select: none;
            background-color: var(--dark-green);
        }
        .select2-results__option .logo-image {
            height: 35px; /* اندازه لوگو در لیست */
            margin-left: 15px; /* فاصله لوگو از متن */
            vertical-align: middle;

        }
        .select2-selection__rendered .logo-image {
            height: 24px; /* اندازه لوگو در حالت انتخاب شده */
            margin-left: 5px;
            vertical-align: middle;
        }
        </style>
</head>
<body class="{{ 'chat-page' if 'chat.html' in request.path else '' }}">
    <div id="loader">
        <img src="/static/images/noBgWhite(1)cut.png" alt="" style="width: 30%;">
        <img class="rotater" src="/static/images/noBgWhite(1)cut3.png" alt="" style="width: 20%;">
        <!-- <div class="loader-div"></div>
        <div class="loader-div"></div>
        <div class="loader-div"></div>
        <div class="loader-div"></div>
        <div class="loader-div"></div>
        <div class="loader-div"></div>
        <div class="loader-div"></div>
        <div class="loader-div"></div>
        <div class="loader-div"></div>
        <div class="loader-div"></div>
        <h1 class="position-absolute translate-middle" style="top: 65%; left: 50%; font-size: 5rem;">stock</h1> -->
    </div>
    <div id="pull-spinner" style="position: fixed; top: -60px; left: 50%; transform: translateX(-50%); z-index: 9999; transition: top 0.3s;">
        <div class="spinner"></div>
      </div>
    <nav class="navbar navbar-dark bg-dark d-lg-none d-md-none d-sm-flex sticky-top">
      <div class="container-fluid d-flex flex-nowrap">
        <div class="d-flex flex-nowrap w-75 align-items-center">
                <div class="input-group flex-grow-1 me-2">
                    <input id="search-input-mobile" class="inputs searcher txt-black" type="search" placeholder="جستجو..." name="search" value="{{ request.args.get('search', '') }}">
                </div>
        </div>
        <a href="{{ url_for('main.chatbot_page_render') }}" class="btn btn-lg me-2 rounded-2 shadow w-25" id="floatingChatButton" title="چت با هوش مصنوعی">
            <i class="bi bi-robot"></i>
            <p class="chat-label mt-1 text-nowrap">چت هوشمند</p>
        </a>
      </div>
    </nav>

    <nav class="navbar navbar-expand-md bg-light mb-4 sticky-top p-0 pb-lg-2 {{ 'd-none' if 'chat.html' in request.path else '' }}" style="padding-top: 90px;">
        <div class="w-100 m-0">
            <div class="collapse navbar-collapse ms-0" id="navbarNav">

                <a class="navbar-brand text-light txt-black" href="{{ url_for('main.index') }}" style="font-size: 3rem;">استوک</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <form class="d-lg-flex d-md-none d-sm-none w-100" action="{{ url_for('main.index') }}" method="GET">
                    <div class="d-flex w-75 m-auto gap-2 align-items-center"> {# اضافه کردن align-items-center #}

                        {# ... کد دراپ‌دان استان شما ... #}
                        <div class="dropdown w-25">
                            <button class="btn dropdown-toggle w-100 p-2 txt-black chooser" type="button"
                                    id="provinceDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span>انتخاب استان</span>
                            </button>
                            <ul class="dropdown-menu w-100 p-2" aria-labelledby="provinceDropdown"
                                id="provinceList" style="max-height: 20rem; overflow-y: auto; background-color: var(--black-color);">
                                <li>
                                    <input type="text" id="provinceSearch" class="form-control mb-2"
                                           placeholder="جستجوی استان..." onkeyup="filterProvinces()" onclick="event.stopPropagation();">
                                </li>
                                <li><a class="dropdown-item txt-black" href="https://stockdivar.ir" onclick="selectProvince('desktop', '')">همه استان ها</a></li>
                                {% for province in provinces %}
                                <li class="province-item text-end"><a class="dropdown-item txt-black" href="#" onclick="selectProvince('desktop', '{{ province }}')">{{ province }}</a></li>
                                {% endfor %}
                            </ul>
                            <input type="hidden" name="province_search" id="provinceInput" value="{{ request.args.get('province_search', '') }}">
                        </div>
                    
                        {# ... کد دراپ‌دان شهر شما ... #}
                        <div class="dropdown w-25">
                            <button class="btn dropdown-toggle w-100 p-2 txt-black chooser" type="button" id="cityDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                انتخاب شهر
                            </button>
                            <ul class="dropdown-menu w-100 p-2" aria-labelledby="cityDropdown"
                                id="cityList" style="max-height: 20rem; overflow-y: auto; background-color: #3A3A3C;">
                                <li><a class="dropdown-item txt-black" href="#" onclick="selectCity('desktop', '')">انتخاب شهر</a></li>
                            </ul>
                            <input type="hidden" name="city_search" id="cityInput" value="{{ request.args.get('city_search', '') }}">
                        </div>
                    
                        <div class="input-group w-75 me-2">
                            <input id="search-input-desktop" class="form-control inputs txt-black" type="search" placeholder="جستجو..." name="search"
                                value="{{ request.args.get('search', '') }}">
                        </div>
                    </div>
                </form>
                <input type="file" id="imageSearchInput" accept="image/*" style="display: none;"> {# فیلد مخفی برای آپلود عکس #}
                <div id="imageSearchSpinner" class="spinner-border text-primary" role="status" style="display: none; position: fixed; top: 50%; left: 50%;">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>

                
                
                

                <ul class="navbar-nav pe-0 me-auto w-auto float-start ms-2">
                    <li class="nav-item header-tabs pt-1 pb-2 pe-4 ps-4 text-center font-300 position-relative">
                        <a class="nav-link text-light m-0 p-0 w-100 h-100 d-block txt-black" href="{{ url_for('main.index') }}">
                            <i class="bi bi-cart3 txt-lighter fs-3 m-0 p-0 me-1"></i> 
                            <span>محصولات</span>
                        </a>
                    </li>

                    <li class="nav-item header-tabs pt-1 pb-2 pe-4 ps-4 text-center font-300 position-relative">
                        <a class="nav-link text-light m-0 p-0 w-100 h-100 d-block txt-black" href="{{ url_for('main.conversations') }}">
                            <i class="bi bi-chat-left-text txt-lighter fs-3 m-0 p-0 me-1"></i> 
                            <span class="text-nowrap">گفت گو</span>
                        </a>
                    </li>
                    
                    {% if current_user.is_authenticated %}
                        <li class="nav-item header-tabs pt-1 pb-2 pe-4 ps-4 text-center font-300 position-relative">
                            <a class="nav-link text-light m-0 p-0 w-100 h-100 d-block txt-black" href="{{ url_for('main.dashboard') }}">
                                <i class="bi bi-person txt-lighter fs-3 m-0 p-0 me-1"></i> 
                                <span class="text-nowrap">استوک من</span>
                            </a>
                        </li>
                        <li class="nav-item header-tabs pt-1 pb-2 pe-4 ps-4 text-center font-300 position-relative">
                            <a href="{{ url_for('main.new_product') }}" class="nav-link text-light m-0 p-0 w-100 h-100 d-block txt-black">
                                <i class="bi bi-plus-square txt-lighter fs-3 m-0 p-0 me-1"></i> 
                                <span style="white-space: nowrap;">محصول جدید</span>
                            </a>
                        </li>
                    {% endif %}

                    <!-- <li class="nav-item header-tabs pt-1 pb-2 pe-4 ps-4 text-center font-300 position-relative">
                        <a class="nav-link text-primary m-0 p-0 w-100 h-100 d-block txt-black" href="{{ url_for('main.chatbot_page_render') }}">
                            <i class="bi bi-person text-primary txt-lighter fs-3 m-0 p-0 me-1 m-auto"></i><br> 
                            <span class="text-nowrap text-end text-primary">چت هوشمند</span>
                        </a>
                    </li> -->
                    
                    {% if current_user.is_admin %}
                        <li class="nav-item header-tabs pt-1 pb-2 pe-3 ps-3 text-center font-300 position-relative">
                            <a class="nav-link text-danger m-0 p-0 w-100 h-100 d-block" href="{{ url_for('main.admin_dashboard') }}">
                                <i class="bi bi-kanban text-danger fs-3 m-0 p-0 w-100 me-2"></i>
                                <span>مدیریت</span>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% if current_user.is_authenticated %}
                        <li class="nav-item header-tabs pt-1 pb-2 pe-4 ps-4 text-center font-300 position-relative">
                            <a class="nav-link text-danger m-0 p-0 w-100 h-100 d-block" href="{{ url_for('main.logout') }}">
                                <i class="bi bi-box-arrow-left text-danger fs-3 m-0 p-0 me-1"></i> 
                                <span>خروج</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item header-tabs pt-1 pb-2 pe-4 ps-4 text-center font-300 position-relative">
                            <a class="nav-link text-success m-0 p-0 w-100 h-100 d-block" href="{{ url_for('main.login_with_phone') }}">
                                <i class="bi bi-box-arrow-in-left text-success fs-3 m-0 p-0 me-1"></i><br>
                                <span>ورود/ثبت نام</span>
                            </a>
                        </li>
                    {% endif %}
                    
                    
                </ul>
               
            </div>
        </div>
    </nav>

    
   <!-- فرم موبایل
    {# در فایل base.html، داخل فرم جستجوی موبایل #}
    <form class="d-lg-none d-md-flex d-sm-flex w-100 {{ 'd-none' if 'chat.html' in request.path else '' }}" action="{{ url_for('main.index') }}" method="GET">
        <div class="d-flex w-100 m-auto flex-wrap">
            
            {# ... کد دراپ‌دان استان موبایل شما ... #}
             <div class="dropdown w-50 m-0">
                <button class="btn p-2 dropdown-toggle w-100 outline-none txt-black m-0" type="button" id="provinceDropdownMobile" style="font-size: 1.25rem;" data-bs-toggle="dropdown" aria-expanded="false">
                    انتخاب استان
                </button>
                <ul class="dropdown-menu text-end chooser w-100 overflow-auto" id="provinceListMobile" style="max-height: 20rem; z-index: 99999;">
                    <li>
                        <input type="text" id="provinceSearchMobile" class="form-control w-100 p-2 mb-2" placeholder="جستجوی استان..." onkeyup="filterProvincesMobile()" onclick="keepDropdownOpen(event)">
                    </li>
                    <li><a class="dropdown-item txt-black" href="https://stockdivar.ir" style="font-size: 1.5rem;" onclick="selectProvince('mobile', '')">همه استان ها</a></li>
                    {% for province in provinces %}
                    <li class="province-item-mobile"><a class="dropdown-item txt-black" href="#" onclick="selectProvince('mobile', '{{ province }}')">{{ province }}</a></li>
                    {% endfor %}
                </ul>
                <input type="hidden" name="province_search" id="provinceInputMobile" value="{{ request.args.get('province_search', '') }}">
            </div>
        
            {# ... کد دراپ‌دان شهر موبایل شما ... #}
            <div class="dropdown w-50 m-0 txt-black">
                <button class="btn p-2 dropdown-toggle w-100 outline-none txt-black m-0" style="font-size: 1.25rem;" type="button" id="cityDropdownMobile" data-bs-toggle="dropdown" aria-expanded="false">
                    انتخاب شهر
                </button>
                <ul class="dropdown-menu text-end chooser w-100 txt-black" id="cityListMobile" style="background-color: #3A3A3C; z-index: 99999;">
                    <li><a class="dropdown-item txt-black" href="#" style="font-size: 1.5rem;" onclick="selectCity('mobile', '')">انتخاب شهر</a></li>
                </ul>
                <input type="hidden" name="city_search" id="cityInputMobile" value="{{ request.args.get('city_search', '') }}">
            </div>
        
            <div class="d-flex flex-nowrap w-100 mt-3 align-items-center"> {# اضافه کردن align-items-center #}
                {# <<<<<<< شروع تغییرات برای جستجوی تصویری در موبایل >>>>>>> #}
                <div class="input-group flex-grow-1 me-2"> {# استفاده از input-group و flex-grow-1 #}
                    <input class="form-control inputs searcher txt-black" type="search" placeholder="جستجو..." name="search" value="{{ request.args.get('search', '') }}">
                </div>
                 {# <<<<<<< پایان تغییرات برای جستجوی تصویری در موبایل >>>>>>> #}
                <button class="btn header-tabs w-auto txt-black" type="submit">جستجو</button> {# تغییر w-25 به w-auto #}
            </div>
        </div>
    </form>
    {# فیلد مخفی آپلود عکس و اسپینر که در بالا تعریف شد، برای هر دو فرم استفاده می‌شود و نیازی به تکرار نیست #} -->

    <!-- <button id="toggleButton">تغییر تم</button> -->


    <div class="container">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    
    <div id="custom-popup" class="custom-popup-class">
        <a id="copy-whatsapp-number" target="_blank" class="popover-link nav-link">
            <i class="bi bi-whatsapp" style="color: #25D366;"></i>
            <span class="txt-black">شماره واتساپ بازخورد</span>
        </a><br>
        <a href="https://stockheydari.ir/abut-us/" target="_blank" class="popover-link nav-link">
            <i class="bi bi-telephone" style="color: #007bff;"></i>
            <span class="txt-black">درباره ما</span>
        </a>
    </div>


        
    <div class="bottom-nav d-md-none">
        <ul class="navbar-nav flex-row align-items-center w-100">
            <li class="nav-item">
                <a style="font-size: .7rem;" class="nav-link active txt-black" href="{{ url_for('main.index') }}">
                    <i class="bi bi-house-door"></i>
                    <span>خانه</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" id="custom-popup-trigger" style="font-size: .7rem;" class="nav-link txt-black">
                    <i class="bi bi-headset"></i>
                    <span>پشتیبانی</span>
                </a>
            </li>

            <li class="fab-container">
                <a href="{{ url_for('main.new_product') }}" class="fab pt-1 pb-0" title="ثبت محصول جدید">
                    <i class="bi bi-plus-lg"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a style="font-size: .7rem;" class="nav-link txt-black" href="{{ url_for('main.conversations') }}">
                    <i class="bi bi-chat-left-text"></i>
                    <span>گفت‌وگو</span>
                </a>
            </li>
            <li class="nav-item">
                <a style="font-size: .7rem;" class="nav-link txt-black" href="{{ url_for('main.dashboard') if current_user.is_authenticated else url_for('main.login_with_phone') }}">
                    <i class="bi bi-person"></i>
                    <span>استوک من</span>
                </a>
            </li>
        </ul>
    </div>

    
    <footer class="w-100 text-start pt-4 px-3 {{ 'd-none' if 'chat.html' in request.path else '' }}" style="background-color: #1f1f1f; color: #f1f1f1; z-index: 2;">
        <div class="w-100 d-flex flex-column flex-md-row align-items-start justify-content-between gap-4 {{ 'd-none' if 'chat.html' in request.path else '' }}">
            <!-- Carousel بخش عکس -->
            


            <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content bg-dark">
                        <div class="modal-body text-center">
                            <img id="modalImage" src="" class="modal-img rounded">
                            <p id="modalCaption" class="text-light mt-3"></p>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- اطلاعات تماس -->
            <ul class="w-100 w-md-25 list-unstyled text-end">
                <li class="mb-2">سایت ما: <a href="https://stockheydari.ir" class="text-decoration-none" style="color: #00bcd4;">stockheydari.ir</a></li>
                <li class="mb-2">تلفن ثابت: <span dir="ltr">021 91691502</span></li>
                <li class="mb-2">تماس با پشتیبانی: <span dir="ltr">021 56699640</span></li>
                <li class="mb-2">آدرس شرکت: تهران، اسلامشهر، سرنوری، ک لادن، پ 12</li>
                <li class="mb-2">قدرت گرفته از مجموعه هیلتی حیدری</li>
                <li class="mb-2"><a href="https://stockheydari.ir/abut-us/" class="text-decoration-none" style="color: #00bcd4;">درباره ما</a></li>
            </ul>

            <div class="d-flex justify-content-center mt-lg-5 me-lg-5">
                <a referrerpolicy='origin' target='_blank' href='https://trustseal.enamad.ir/?id=607542&Code=SkjH3jsePkBAQ1wrjfvVgI4lX8jicXrW'><img referrerpolicy='origin' src='https://trustseal.enamad.ir/logo.aspx?id=607542&Code=SkjH3jsePkBAQ1wrjfvVgI4lX8jicXrW' alt='' style='cursor:pointer' code='SkjH3jsePkBAQ1wrjfvVgI4lX8jicXrW'></a>
            </div>
        </div>
    
        <div class="w-100 text-center mt-4 border-top border-secondary pt-3 pb-3">
            <p class="m-0" style="font-size: 14px;">© ۲۰۲۵ | تمامی حقوق متعلق به شرکت هیلتی حیدری و توسعه دهنده ی آن است.</p>
        </div>
    </footer>
    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const copyButton = document.getElementById('copy-whatsapp-number');
    if (copyButton) {
        copyButton.addEventListener('click', function (event) {
            event.preventDefault();
            const phoneNumber = '09910689541';
            
            navigator.clipboard.writeText(phoneNumber).then(function() {
                // موفقیت در کپی کردن
                const originalText = copyButton.querySelector('span');
                if (originalText) {
                    originalText.textContent = 'شماره واتساپ کپی شد!';
                    copyButton.style.opacity = '0.7';
                    
                    setTimeout(function() {
                        originalText.textContent = 'پشتیبانی واتساپ';
                        copyButton.style.opacity = '1';
                    }, 2000); // بازگشت به حالت اولیه بعد از ۲ ثانیه
                }
            }, function(err) {
                // خطا در کپی کردن
                console.error('امکان کپی کردن وجود ندارد: ', err);
                alert('شماره پشتیبانی: ' + phoneNumber); // به عنوان جایگزین، شماره را در یک alert نمایش می‌دهیم
            });
        });
    }
});
</script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const trigger = document.getElementById('custom-popup-trigger');
            const popup = document.getElementById('custom-popup');
        
            if (trigger && popup) {
                trigger.addEventListener('click', function (event) {
                    event.preventDefault(); // جلوگیری از رفتار پیش‌فرض لینک
                    event.stopPropagation(); // جلوگیری از بسته شدن فوری
                    popup.classList.toggle('show');
                });
            }
        
            // بستن پاپ‌آپ با کلیک روی هر جای دیگر صفحه
            window.addEventListener('click', function (event) {
                if (popup && popup.classList.contains('show')) {
                    if (!popup.contains(event.target) && !trigger.contains(event.target)) {
                        popup.classList.remove('show');
                    }
                }
            });
        });
    </script>
    <script>
        let startY = 0;
        let isPulling = false;
        let spinner = document.getElementById("pull-spinner");
        
        window.addEventListener("touchstart", function (e) {
            if (window.scrollY === 0) {
                startY = e.touches[0].clientY;
                isPulling = true;
            }
        });
        
        window.addEventListener("touchmove", function (e) {
            if (!isPulling) return;
        
            let currentY = e.touches[0].clientY;
            let diffY = currentY - startY;
        
            if (diffY > 30 && diffY < 130) {
                spinner.style.top = `${diffY - 60}px`; // اسپینر پایین‌تر نمایش داده می‌شود
            }
        
            if (diffY >= 130) {
                spinner.style.top = `150px`; // اسپینر در پایین نمایان می‌ماند
                if (!spinner.dataset.loading) {  // جلوگیری از چندبار اجرا شدن رفرش
                    spinner.dataset.loading = "true";
                    location.reload(); // رفرش صفحه
                }
                isPulling = false;
            }
        });
        
        window.addEventListener("touchend", function () {
            // اگر رفرش کامل نشده بود اسپینر رو پنهان کن
            if (!spinner.dataset.loading) {
                spinner.style.top = `-60px`; 
            }
            isPulling = false;
        });
        
        // رویداد بارگذاری کامل صفحه
        window.addEventListener("load", function () {
            // وقتی صفحه کاملا لود شد، اسپینر رو پنهان کن بالا
            spinner.style.top = `-60px`; 
            spinner.dataset.loading = ""; // ریست کردن وضعیت لودینگ
        });
        </script>
        
        <script>
        document.querySelectorAll('.img-clickable').forEach(img => {
            img.addEventListener('click', function () {
                const modalImage = document.getElementById('modalImage');
                const modalCaption = document.getElementById('modalCaption');
                modalImage.src = this.getAttribute('data-img-src');
                modalCaption.textContent = this.getAttribute('data-caption') || "";
            });
        });
        </script>
                
    <script>
        document.querySelectorAll('.img-clickable').forEach(img => {
            img.addEventListener('click', function () {
                const modalImage = document.getElementById('modalImage');
                const modalCaption = document.getElementById('modalCaption');
                modalImage.src = this.getAttribute('data-img-src');
                modalCaption.textContent = this.getAttribute('data-caption') || "";
            });
        });

    </script>
	<script>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', function () {
				navigator.serviceWorker.register('/static/service-worker.js')
					.then(function (registration){
						console.log('serviceWorker registration successful:', registration.scope);
					}, function (err) {
						console.log('serviceWorker failed', err);
					});
			});
		};
	</script>
    
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            document.body.classList.add('loaded');

            // بعد از محو شدن کامل، لودر رو کلاً display:none میکنیم
            setTimeout(function() {
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.style.display = 'none';
                }
            }, 700); // یکم بیشتر از 0.6s که تو transition دادیم
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/js/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        document.querySelectorAll(".header-tabs").forEach((element) => {
    function updateRipplePosition(e) {
        const rect = element.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        element.style.setProperty('--mouse-x', `${x}%`);
        element.style.setProperty('--mouse-y', `${y}%`);
    }

    element.addEventListener('mousemove', updateRipplePosition);
    element.addEventListener('touchstart', (e) => {
        if (e.touches.length > 0) {
            updateRipplePosition(e.touches[0]);
        }
    });

    element.addEventListener('click', (e) => {
        updateRipplePosition(e);

        // حذف کلاس برای ریست، اگه قبلاً بوده
        element.classList.remove('clicked');

        // اجرای دوباره در فریم بعد برای اعمال ripple درست
        requestAnimationFrame(() => {
            element.classList.add('clicked');

            // حذف بعد از مدت افکت برای آمادگی کلیک بعدی
            setTimeout(() => {
                element.classList.remove('clicked');
            }, 800); // هماهنگ با transition
        });
    });
});

        
        

        document.addEventListener("DOMContentLoaded", function() {
            console.log("citiesByProvince Loaded:", citiesByProvince);


            function updateCities(formType, province) {
                const cityList = document.getElementById(formType === 'desktop' ? "cityList" : "cityListMobile");
                cityList.innerHTML = '';  // پاک کردن لیست قبلی

                if (province in citiesByProvince) {
                    citiesByProvince[province].forEach(city => {
                        let li = document.createElement("li");
                        let a = document.createElement("a");
                        a.className = "dropdown-item";
                        a.href = "#";
                        a.innerText = city;
                        a.onclick = function() { selectCity(formType, city); };
                        li.appendChild(a);
                        cityList.appendChild(li);
                    });
                } else {
                    cityList.innerHTML = '<li><a class="dropdown-item" href="#" onclick="selectCity(\'' + formType + '\', \'\')">انتخاب شهر</a></li>';
                }
            }


           window.selectProvince = function(formType, province) {
                console.log("استان انتخاب‌شده:", province);
                const provinceInput = document.getElementById(formType === 'desktop' ? "provinceInput" : "provinceInputMobile");
                const provinceDropdown = document.getElementById(formType === 'desktop' ? "provinceDropdown" : "provinceDropdownMobile");
                    
                provinceInput.value = province;
                    
                // تغییر فقط متن داخل دکمه بدون حذف ویژگی‌های بوت‌استرپ
                const span = provinceDropdown.querySelector("span");
                if (span) {
                    span.textContent = province || "انتخاب استان";
                }
            
                updateCities(formType, province);
            };
            


            window.selectCity = function(formType, city) {
                const cityInput = document.getElementById(formType === 'desktop' ? "cityInput" : "cityInputMobile");
                const cityDropdown = document.getElementById(formType === 'desktop' ? "cityDropdown" : "cityDropdownMobile");
                cityInput.value = city;
                cityDropdown.innerText = city || "انتخاب شهر";
            };

    });

    function filterProvinces() {
        let input = document.getElementById("provinceSearch").value.toLowerCase();
        let items = document.querySelectorAll("#provinceList .province-item");

        items.forEach(item => {
            let text = item.innerText.toLowerCase();
            item.style.display = text.includes(input) ? "block" : "none";
        });
    }
    function filterProvincesMobile() {
    let input = document.getElementById("provinceSearchMobile").value.toLowerCase();
    let items = document.querySelectorAll("#provinceListMobile .province-item-mobile");

    items.forEach(item => {
        let text = item.innerText.toLowerCase();
        item.style.display = text.includes(input) ? "block" : "none";
    });
}

// جلوگیری از بسته شدن Dropdown هنگام تایپ در موبایل
function keepDropdownOpen(event) {
    event.stopPropagation();
}



// const button = document.getElementById("toggleButton");

// button.addEventListener("click", function() {
//     const root = document.documentElement;

//     // بررسی وضعیت تم (تاریک یا روشن)
//     if (root.style.getPropertyValue("--black-color") === "#F8F8F8") {
//         // تغییر به دارک مود
//         root.style.setProperty("--black-color", "#1C1C1E");
//         root.style.setProperty("--dark-green", "#3A3A3C");
//         root.style.setProperty("--light-green", "#9B1B30");
//         root.style.setProperty("--light-white", "#f1f1f1");
//         root.style.setProperty("--txt-color", "#F8F8F8");
//     } else {
//         // تغییر به لایت مود
//         root.style.setProperty("--black-color", "#F8F8F8");
//         root.style.setProperty("--dark-green", "#E0E0E0");
//         root.style.setProperty("--light-green", "#9B1B30");
//         root.style.setProperty("--light-white", "#F1F1F1");
//         root.style.setProperty("--txt-color", "#1C1C1E");
//     }
// });




    console.log(window.citiesByProvince);

    </script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // انتخاب تمام فیلدهای ورودی که در جستجو نقش دارند
    const searchInputDesktop = document.getElementById('search-input-desktop');
    const searchInputMobile = document.getElementById('search-input-mobile');
    const provinceInputDesktop = document.getElementById('provinceInput');
    const cityInputDesktop = document.getElementById('cityInput');
    const provinceInputMobile = document.getElementById('provinceInputMobile');
    const cityInputMobile = document.getElementById('cityInputMobile');
    const resultsContainer = document.getElementById('product-results-container');
    
    let debounceTimeout;

    // تابع اصلی برای انجام جستجوی زنده
    function performLiveSearch() {
        if (!resultsContainer) return;

        resultsContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"><span class="visually-hidden">در حال جستجو...</span></div></div>';

        const searchTerm = (document.getElementById('search-input-mobile').value || document.getElementById('search-input-desktop').value);
        const province = (document.getElementById('provinceInputMobile').value || document.getElementById('provinceInput').value);
        const city = (document.getElementById('cityInputMobile').value || document.getElementById('cityInput').value);

        const queryParams = new URLSearchParams({
            search: searchTerm,
            province_search: province,
            city_search: city
        });

        fetch(`/live_search?${queryParams.toString()}`)
            .then(response => response.text())
            .then(html => {
                resultsContainer.innerHTML = html;

                // *** مهم‌ترین بخش: فراخوانی مجدد تابع انیمیشن ***
                // بعد از اینکه محصولات جدید در صفحه قرار گرفتند، به جاوا اسکریپت می‌گوییم
                // که انیمیشن‌ها را برای آن‌ها نیز فعال کند.
                if (typeof initializeAnimations === 'function') {
                    initializeAnimations();
                }

            })
            .catch(error => {
                console.error('خطا در جستجوی زنده:', error);
                resultsContainer.innerHTML = '<p class="text-center text-danger">خطایی در هنگام جستجو رخ داد.</p>';
            });
    }

    // تابع Debounce برای جلوگیری از درخواست‌های مکرر هنگام تایپ
    function debounce(func, delay) {
        return function(...args) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    const debouncedSearch = debounce(performLiveSearch, 400); // تاخیر 400 میلی‌ثانیه

    // اتصال رویدادها به فیلدهای ورودی
    if (searchInputDesktop) {
        searchInputDesktop.addEventListener('input', debouncedSearch);
    }
    if (searchInputMobile) {
        searchInputMobile.addEventListener('input', debouncedSearch);
    }

    // ------ مهم: یکپارچه‌سازی با کدهای فعلی شما ------
    // ما توابع selectProvince و selectCity شما را ویرایش می‌کنیم تا جستجوی زنده را فراخوانی کنند.

    const originalSelectProvince = window.selectProvince;
    window.selectProvince = function(formType, province) {
        originalSelectProvince(formType, province); // تابع اصلی شما را اجرا می‌کند
        performLiveSearch(); // و سپس جستجوی زنده را فراخوانی می‌کند
    };

    const originalSelectCity = window.selectCity;
    window.selectCity = function(formType, city) {
        originalSelectCity(formType, city); // تابع اصلی شما را اجرا می‌کند
        performLiveSearch(); // و سپس جستجوی زنده را فراخوانی می‌کند
    };

});
</script>
</body>

</body>
</html>
