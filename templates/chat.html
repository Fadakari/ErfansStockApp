{% extends "base.html" %}
{% block content %}
<div class="chat-container">
  <div class="chat-header">ğŸ’¬ {{ user.username }}</div>

  <div class="chat-box">
    {% for msg in messages %}
    <div class="message-container {% if msg.sender_id == current_user.id %}own-message{% else %}other-message{% endif %}" id="msg-{{ msg.id }}" onclick="toggleDropdown(this)">
      <div class="chat-message mt-2 {% if msg.sender_id == current_user.id %}chat-message you{% else %}chat-message other{% endif %}">
        <strong>{{ msg.sender.username }} :</strong>
        <span class="content">{{ msg.content }}</span>

        <div class="dropdown-menu">
          {% if msg.sender_id == current_user.id %}
            <button onclick="copyMessage(event, {{ msg.id }})">ğŸ“‹ Ú©Ù¾ÛŒ</button>
            <button onclick="editMessage(event, {{ msg.id }})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteMessage(event, {{ msg.id }})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <button onclick="showInfo(event, {{ msg.id }})">â„¹ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
          {% else %}
            <button onclick="copyMessage(event, {{ msg.id }})">ğŸ“‹ Ú©Ù¾ÛŒ</button>
            <button onclick="replyMessage(event, {{ msg.id }})">ğŸ” Ø±ÛŒÙ¾Ù„Ø§ÛŒ</button>
            <button onclick="showInfo(event, {{ msg.id }})">â„¹ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="reply-container" id="reply-container" style="display: none;">
    <div class="reply-box">
      <strong>Ù¾Ø§Ø³Ø® Ø¨Ù‡:</strong> <span id="reply-user"></span><br>
      <span id="reply-content"></span><br>
      <button onclick="clearReply()">Ù„ØºÙˆ Ù¾Ø§Ø³Ø®</button>
    </div>
  </div>

  <form method="POST" class="chat-form">
    <input class="inputs" type="text" name="content" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." required>
    <button type="submit">Ø§Ø±Ø³Ø§Ù„</button>
  </form>
</div>

<script>
  function toggleDropdown(container) {
    // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ± Ø¯Ø±Ø§Ù¾â€ŒØ¯Ø§ÙˆÙ†â€ŒÙ‡Ø§
    document.querySelectorAll('.message-container').forEach(el => {
      if (el !== container) el.classList.remove("active");
    });

    // Ø¨Ø§Ø² ÛŒØ§ Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø§Ù¾â€ŒØ¯Ø§ÙˆÙ† ÙØ¹Ù„ÛŒ
    container.classList.toggle("active");
  }

  function copyMessage(event, id) {
    event.stopPropagation();
    const text = document.querySelector(`#msg-${id} .content`).innerText;
    navigator.clipboard.writeText(text)
      .then(() => alert("Ù¾ÛŒØ§Ù… Ú©Ù¾ÛŒ Ø´Ø¯ âœ…"))
      .catch(() => alert("Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ù¾ÛŒØ§Ù… âŒ"));
  }

  function editMessage(event, id) {
    event.stopPropagation();
    const content = document.querySelector(`#msg-${id} .content`);
    const oldContent = content.innerText;
    const newContent = prompt("Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ§Ù…:", oldContent);
    if (newContent && newContent.trim() !== "") {
      fetch(`/edit_message/${id}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrf_token")
        },
        body: JSON.stringify({ content: newContent })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) content.innerText = newContent;
        else alert("Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…");
      });
    }
  }

  function deleteMessage(event, id) {
    event.stopPropagation();
    if (confirm("Ø­Ø°Ù Ù¾ÛŒØ§Ù…ØŸ")) {
      fetch(`/delete_message/${id}`, {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrf_token") }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) document.getElementById(`msg-${id}`).remove();
        else alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾ÛŒØ§Ù…");
      });
    }
  }

  function showInfo(event, id) {
    event.stopPropagation();
    alert(`Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾ÛŒØ§Ù… ID: ${id} (Ù…Ø«Ù„Ø§Ù‹ Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ùˆ ...)`);
  }

  function replyMessage(event, id) {
    event.stopPropagation();
    const username = document.querySelector(`#msg-${id} strong`).innerText;
    const content = document.querySelector(`#msg-${id} .content`).innerText;

    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ÙÛŒÙ„Ø¯ ÙˆØ±ÙˆØ¯ÛŒ
    document.getElementById('reply-user').innerText = username;
    document.getElementById('reply-content').innerText = content;
    document.getElementById('reply-container').style.display = 'block';

    // ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ØªÙˆØ§ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù¾ÛŒØ§Ù…
    const input = document.querySelector('.chat-form input[name="content"]');
    input.value = `Ù¾Ø§Ø³Ø® Ø¨Ù‡ ${username}: "${content}"\n`;
    input.focus();
  }

  function clearReply() {
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†Ù…Ø§ÛŒØ´ Ø±ÛŒÙ¾Ù„Ø§ÛŒ
    document.getElementById('reply-container').style.display = 'none';
    const input = document.querySelector('.chat-form input[name="content"]');
    input.value = '';  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
  }

  function getCookie(name) {
    let value = `; ${document.cookie}`;
    let parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
</script>
{% endblock %}
