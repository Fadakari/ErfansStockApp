<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ú†Øª</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <meta name="theme-color" content="#9B1B30">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/Icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Scripts -->
    <script src="/static/js/theme.js" defer></script>

    <!-- Styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>

 body {
    height: 50rem;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
}
/* body {
    border: 3px solid red !important;
}
.chat-page-container {
    border: 3px solid blue !important;
}
.chat-box {
    border: 3px solid green !important;
}
form.myform {
    border: 3px solid orange !important;
} */
/* Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø®Ù„ label Ùˆ Ø¨Ø§Ù„Ø§ÛŒ Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø§Ø´Ù‡ */
.custom-file-upload {
    position: relative; /* Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ position:absolute Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ */
}

/* ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø§Ú©Ø³ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ */
.preview-tooltip {
    bottom: 100%;  /* Ø¯Ù‚ÛŒÙ‚Ø§ Ø¨Ø§Ù„Ø§ÛŒ Ø¢ÛŒÚ©ÙˆÙ† */
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    width: 120px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 5px;
    z-index: 1000;
}

/* Ù…Ø«Ù„ Ø¨Ø§Ù„ÙˆÙ† Ú©ÙˆÚ†Ú©: */
.preview-tooltip::after {
    content: "";
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 10px 10px 0 10px;
    border-style: solid;
    border-color: #fff transparent transparent transparent;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
}

/* ØªØµÙˆÛŒØ± Ø¯Ø§Ø®Ù„ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ */
#simple-preview-img {
    width: 100%;
    border-radius: 6px;
    display: block;
}
/* .spinner {
          width: 32px;
          height: 32px;
          border: 4px solid #ccc;
          border-top: 4px solid var(--light-green);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          background: transparent;
          position: fixed;
          top: -60px;   
          left: 80%;
          transform: translateX(-80%);
          transition: top 0.3s ease;
          z-index: 10000;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        } */
/* Ø¯Ú©Ù…Ù‡ Ø¶Ø±Ø¨Ø¯Ø± Ø­Ø°Ù */
.preview-close-btn {
    position: absolute;
    top: 2px;
    right: 5px;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    width: 18px;
    height: 18px;
    opacity: 0.8;
    z-index: 1100;
}
.preview-close-btn:hover {
    opacity: 1;
}
/* Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ ØªÚ¯ <style> Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ */

.message-meta {
    display: block;
    text-align: left; /* Ú†ÛŒÙ†Ø´ Ø§Ø² Ú†Ù¾ Ø¨Ø±Ø§ÛŒ Ø²Ù…Ø§Ù† Ùˆ ØªÛŒÚ© */
    font-size: 0.75rem;
    color: #888;
    margin-top: 5px;
}

.message.sent .message-meta .status-icon {
    margin-left: 5px; /* Ú©Ù…ÛŒ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ø²Ù…Ø§Ù† Ùˆ ØªÛŒÚ© */
}

.message.sent .message-meta {
    direction: ltr; /* Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØµØ­ÛŒØ­ Ø²Ù…Ø§Ù† Ùˆ ØªÛŒÚ© Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ */
}
    </style>
</head>
<body class="text-dark" style="background: var(--black-color);">
    <!-- <div id="pull-spinner" style="position: fixed; top: -60px; left: 50%; transform: translateX(-50%); z-index: 9999; transition: top 0.3s;">
        <div class="spinner"></div>
      </div> -->
    <button class="btn header-tabs m-auto py-1 px-3 float-start w-25" onclick="history.back()">
        <i class="bi bi-arrow-left fs-3 txt-black"></i>
    </button><br>
        <div class="chat-box">
            <div class="chat">
                {% for msg in messages %}
                    <div class="message {{ 'sent' if msg.sender_id == current_user.id else 'received' }} txt-black position-relative" id="message-{{ msg.id }}">
                        {% if msg.sender_id == current_user.id %}
                        <div class="dropdown position-absolute top-0 start-0 me-1 mt-1">
                            <button class="btn btn-sm dropdown-toggle p-0 px-2" type="button" data-bs-toggle="dropdown"></button>
                            <ul class="dropdown-menu" style="background: var(--black-color);">
                                <li>
                                    <button type="button" class="dropdown-item text-primary" onclick="enableEdit({{ msg.id }}, '{{ msg.content | urlencode }}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                                </li>
                                <li>
                                    <form method="POST" action="{{ url_for('main.delete_message', message_id=msg.id) }}" onsubmit="return confirm('Ø­Ø°Ù Ù¾ÛŒØ§Ù…ØŸ')">
                                        <button type="submit" class="dropdown-item text-danger">Ø­Ø°Ù</button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    
                        <div id="msg-text-{{ msg.id }}">
                            {{ msg.content }}
                            <div class="message-meta">
                                <span>{{ msg.timestamp.strftime('%H:%M') }}</span>
                                <span class="status-icon"><i class="bi bi-check"></i></span>
                            </div>
                        </div>
                        {% if msg.file_path %}
                            {% if msg.file_path.endswith('.pdf') %}
                                <a href="{{ url_for('static', filename='uploads/' ~ msg.file_path) }}" target="_blank">ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§ÛŒÙ„ PDF</a>
                            {% else %}
                                <img src="{{ url_for('static', filename='uploads/' ~ msg.file_path) }}" 
                                    alt="ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡" 
                                    style="max-width: 100%; max-height: 200px; cursor: pointer;" 
                                    class="img-thumbnail" 
                                    data-bs-toggle="modal" data-bs-target="#imageModal" 
                                    onclick="showImage('{{ url_for('static', filename='uploads/' ~ msg.file_path) }}')">
                            {% endif %}
                        {% endif %}
                    
                        <form id="edit-form-{{ msg.id }}" method="POST" action="{{ url_for('main.edit_message_inline', message_id=msg.id) }}" class="d-none">
                            <textarea name="content" class="form-control mb-2">{{ msg.content }}</textarea>
                            <button type="submit" class="btn btn-sm btn-success">Ø°Ø®ÛŒØ±Ù‡</button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit({{ msg.id }})">Ù„ØºÙˆ</button>
                        </form>
                    </div>
                {% endfor %}
                <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content" style="background: var(--black-color);">
                      <div class="modal-header">
                        <button type="button" class="btn-close txt-black" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <img id="modalImage" src="" alt="ØªØµÙˆÛŒØ± Ø¨Ø²Ø±Ú¯" style="width: 100%; height: auto;">
                      </div>
                    </div>
                  </div>
                </div>
            </div>

            <form id="messageForm" enctype="multipart/form-data" class="myform sticky-bottom" onsubmit="return false;">
                <input type="hidden" name="conversation_id" value="{{ conversation.id }}">
                <input type="text" class="myinput inputs" name="content" id="content" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." required>
                <label for="file-upload" class="custom-file-upload me-2 position-relative" style="display: inline-block;">
                    <i class="bi bi-paperclip"></i>
                    <input id="file-upload" type="file" name="file" accept="image/*,application/pdf" style="display: none;">

                    <div id="simple-preview" class="d-none preview-tooltip position-absolute">
                        <button id="remove-preview" type="button" class="btn-close txt-black" aria-label="Ø­Ø°Ù"></button>
                        <img id="simple-preview-img" src="" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´">
                    </div>
                </label>


                <button type="submit" class="mybtn">Ø§Ø±Ø³Ø§Ù„</button>
            </form>

            

        </div>
        <!-- <form id="messageForm" enctype="multipart/form-data" class="myform sticky-bottom" onsubmit="return false;">
                <input type="hidden" name="conversation_id" value="{{ conversation.id }}">
                <input type="text" class="myinput inputs" name="content" id="content" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." required>
                <label for="file-upload" class="custom-file-upload me-2 position-relative" style="display: inline-block;">
                    <i class="bi bi-paperclip"></i>
                    <input id="file-upload" type="file" name="file" accept="image/*,application/pdf" style="display: none;">
                    
                    <div id="simple-preview" class="d-none preview-tooltip position-absolute">
                        <button id="remove-preview" type="button" class="btn-close txt-black" aria-label="Ø­Ø°Ù"></button>
                        <img id="simple-preview-img" src="" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´">
                    </div>
                </label>
                
            
                <button type="submit" class="mybtn">Ø§Ø±Ø³Ø§Ù„</button>
        </form> -->
    <div class="ccp"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
<script>
    const shownMessageIds = new Set();
</script>
<script>
const fileInput = document.getElementById("file-upload");
const previewContainer = document.getElementById("simple-preview");
const previewImage = document.getElementById("simple-preview-img");
const removePreviewBtn = document.getElementById("remove-preview");

fileInput.addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith("image/")) {
        previewContainer.classList.add("d-none");
        previewImage.src = "";
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        previewImage.src = e.target.result;
        previewContainer.classList.remove("d-none");
    };
    reader.readAsDataURL(file);
});

removePreviewBtn.addEventListener("click", function () {
    fileInput.value = "";              // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
    previewImage.src = "";             // Ø­Ø°Ù Ø¹Ú©Ø³ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
    previewContainer.classList.add("d-none");  // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø§Ú©Ø³ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
});

</script>


    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        function enableEdit(msgId, encodedContent) {
            const content = decodeURIComponent(encodedContent);
            // Ø­Ø§Ù„Ø§ Ø§ÛŒÙ† content Ø±Ùˆ ØªÙˆ textarea Ø¨Ú¯Ø°Ø§Ø±ÛŒ
            document.querySelector(`#edit-form-${msgId} textarea`).value = content;
            document.getElementById("msg-text-" + msgId).classList.add("d-none");
            document.getElementById("edit-form-" + msgId).classList.remove("d-none");
        }

        function cancelEdit(msgId) {
            document.getElementById("edit-form-" + msgId).classList.add("d-none");
            document.getElementById("msg-text-" + msgId).classList.remove("d-none");
        }
        function scrollToBottom() {
            const chat = document.querySelector(".chat");
            chat.scrollTop = chat.scrollHeight;
        }

        window.onload = scrollToBottom;

        function showImage(imageUrl) {
            const modalImage = document.getElementById("modalImage");
            modalImage.src = imageUrl;  // ØªÙ†Ø¸ÛŒÙ… ØªØµÙˆÛŒØ± Ø¨Ø²Ø±Ú¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
        }

        
    </script>

<script>
document.querySelector("form.myform").addEventListener("submit", async function (e) {
        e.preventDefault();

        const form = e.target;
        const contentInput = form.querySelector('#content');
        const fileInput = form.querySelector('#file-upload');
        const messageContent = contentInput.value.trim();
        const previewImage = document.getElementById("simple-preview-img");

        if (!messageContent && !fileInput.files.length) return;

        let localImageUrl = null;
        if (fileInput.files.length > 0 && fileInput.files[0].type.startsWith("image/")) {
            localImageUrl = previewImage.src;
        }

        const tempId = `temp-${Date.now()}`;
        const tempMessage = {
            id: tempId,
            isTemp: true,
            sender_id: {{ current_user.id }},
            content: messageContent,
            timestamp: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }),
            status: 'pending',
            local_image_url: localImageUrl
        };
        
        addMessageToDOM(tempMessage);
        scrollToBottom();

        const formData = new FormData(form);
        form.reset();
        previewImage.src = "";
        document.getElementById("simple-preview").classList.add("d-none");

        try {
            const res = await fetch("{{ url_for('main.send_message') }}", {
                method: "POST",
                body: formData
            });

            const tempBubble = document.getElementById(tempId);
            if (!tempBubble) return;

            if (res.ok) {
                const realMessage = await res.json();
                
                // >>>>>> Ø±Ø§Ù‡ Ø­Ù„ Ù†Ù‡Ø§ÛŒÛŒ: Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø­Ø¨Ø§Ø¨ Ù¾ÛŒØ§Ù… Ø¨Ø§ ID ÙˆØ§Ù‚Ø¹ÛŒ <<<<<<
                const finalMessageData = {
                    ...realMessage, // Ø´Ø§Ù…Ù„ id, content, timestamp, file_path ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ø³Ø±ÙˆØ±
                    isTemp: false,
                    status: 'sent'
                };
                const finalBubble = createMessageBubble(finalMessageData);
                tempBubble.replaceWith(finalBubble); // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø­Ø¨Ø§Ø¨ Ù…ÙˆÙ‚Øª Ø¨Ø§ Ø­Ø¨Ø§Ø¨ Ù†Ù‡Ø§ÛŒÛŒ
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ID Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
                shownMessageIds.add(realMessage.id);

            } else {
                const statusIcon = tempBubble.querySelector('.status-icon i');
                if(statusIcon) statusIcon.className = 'bi bi-exclamation-triangle-fill text-danger';
                tempBubble.title = 'Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚';
            }

        } catch (error) {
            const tempBubble = document.getElementById(tempId);
            if (tempBubble) {
                const statusIcon = tempBubble.querySelector('.status-icon i');
                if (statusIcon) statusIcon.className = 'bi bi-exclamation-triangle-fill text-danger';
                tempBubble.title = 'Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„';
            }
            console.error("Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯:", error);
        }
    });

    // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®ØªÙ† Ù¾ÛŒØ§Ù… Ø¯Ø± DOM
    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§Ú©Ù†ÙˆÙ† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© ØªØ§Ø¨Ø¹ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    function createMessageBubble(msg) {
        const chat = document.querySelector(".chat");
        const isSent = msg.sender_id === {{ current_user.id }};
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${isSent ? "sent" : "received"} txt-black position-relative`;
        
        const messageId = msg.isTemp ? msg.id : msg.id;
        msgDiv.id = msg.isTemp ? messageId : `message-${messageId}`;

        let fileHtml = "";
        if (msg.local_image_url) {
            fileHtml = `<br><img src="${msg.local_image_url}" style="max-width: 100%; max-height: 200px;" class="img-thumbnail">`;
        } else if (msg.file_path) {
            const fileUrl = `/static/uploads/${msg.file_path}`;
            fileHtml = fileUrl.endsWith(".pdf")
                ? `<br><a href="${fileUrl}" target="_blank">ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§ÛŒÙ„ PDF</a>`
                : `<br><img src="${fileUrl}" style="max-width: 100%; max-height: 200px; cursor: pointer;" class="img-thumbnail" data-bs-toggle="modal" data-bs-target="#imageModal" onclick="showImage('${fileUrl}')">`;
        }

        let statusIconHtml = '';
        if (isSent) {
            if (msg.status === 'pending') {
                statusIconHtml = '<i class="bi bi-clock"></i>';
            } else if (msg.status === 'failed') {
                statusIconHtml = '<i class="bi bi-exclamation-triangle-fill text-danger"></i>';
            } else {
                statusIconHtml = '<i class="bi bi-check"></i>';
            }
        }

        const editButtonOnclick = `enableEdit(${messageId}, '${encodeURIComponent(msg.content)}')`;
        const cancelButtonOnclick = `cancelEdit(${messageId})`;

        msgDiv.innerHTML = `
            ${(isSent && !msg.isTemp) ? `
            <div class="dropdown position-absolute top-0 start-0 me-1 mt-1">
                <button class="btn btn-sm dropdown-toggle p-0 px-2" type="button" data-bs-toggle="dropdown"></button>
                <ul class="dropdown-menu" style="background: var(--black-color);">
                    <li><button type="button" class="dropdown-item text-primary" onclick="${editButtonOnclick}">ÙˆÛŒØ±Ø§ÛŒØ´</button></li>
                    <li><form method="POST" action="/delete_message/${messageId}" onsubmit="return confirm('Ø­Ø°Ù Ù¾ÛŒØ§Ù…ØŸ')"><button type="submit" class="dropdown-item text-danger">Ø­Ø°Ù</button></form></li>
                </ul>
            </div>` : ''}
        
            <div id="msg-text-${messageId}">
                ${msg.content}
                ${fileHtml}
                <div class="message-meta">
                    <span>${msg.timestamp}</span>
                    ${isSent ? `<span class="status-icon">${statusIconHtml}</span>` : ''}
                </div>
            </div>
        
            ${isSent ? `
            <form id="edit-form-${messageId}" method="POST" action="/edit_message_inline/${messageId}" class="d-none">
                <textarea name="content" class="form-control mb-2">${msg.content}</textarea>
                <button type="submit" class="btn btn-sm btn-success">Ø°Ø®ÛŒØ±Ù‡</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="${cancelButtonOnclick}">Ù„ØºÙˆ</button>
            </form>` : ''}
        `;
        return msgDiv;
    }

    // ØªØ§Ø¨Ø¹ Ù‚Ø¯ÛŒÙ…ÛŒ addMessageToDOM Ø­Ø§Ù„Ø§ ÙÙ‚Ø· ÛŒÚ© Ù¾ÙˆØ´Ø´ Ø¨Ø±Ø§ÛŒ ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª
    function addMessageToDOM(msg) {
        if (!msg.isTemp && shownMessageIds.has(msg.id)) {
            return;
        }
        const chat = document.querySelector(".chat");
        const bubble = createMessageBubble(msg);
        chat.appendChild(bubble);
        if (!msg.isTemp) {
            shownMessageIds.add(msg.id);
        }
    }

    </script>

<script>
function addMessageToDOM(msg) {
    // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… ØªÚ©Ø±Ø§Ø±ÛŒ
    if (!msg.isTemp && document.getElementById(`message-${msg.id}`)) {
        return; 
    }

    const chat = document.querySelector(".chat");
    const isSent = msg.sender_id === {{ current_user.id }};
    const msgDiv = document.createElement("div");
    msgDiv.className = `message ${isSent ? "sent" : "received"} txt-black position-relative`;
    
    // ID Ù¾ÛŒØ§Ù… Ù…ÙˆÙ‚Øª ÛŒØ§ ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    const messageId = msg.isTemp ? msg.id : msg.id;
    msgDiv.id = msg.isTemp ? msg.id : `message-${msg.id}`;

    let fileHtml = "";
    // <<<< Ø´Ø±ÙˆØ¹ Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ 1: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¹Ú©Ø³ Ù…Ø­Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙÙˆØ±ÛŒ >>>>
    if (msg.local_image_url) {
        fileHtml = `<br><img src="${msg.local_image_url}" style="max-width: 100%; max-height: 200px;" class="img-thumbnail">`;
    } else if (msg.file_path) {
        const fileUrl = `/static/uploads/${msg.file_path}`;
        if (msg.file_path.endsWith(".pdf")) {
            fileHtml = `<br><a href="${fileUrl}" target="_blank">ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§ÛŒÙ„ PDF</a>`;
        } else {
            fileHtml = `<br><img src="${fileUrl}" style="max-width: 100%; max-height: 200px; cursor: pointer;" class="img-thumbnail" data-bs-toggle="modal" data-bs-target="#imageModal" onclick="showImage('${fileUrl}')">`;
        }
    }
    // <<<< Ù¾Ø§ÛŒØ§Ù† Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ 1 >>>>

    let statusIconHtml = '';
    if (isSent) {
        if (msg.status === 'pending') {
            statusIconHtml = '<i class="bi bi-clock"></i>';
        } else {
            statusIconHtml = '<i class="bi bi-check"></i>';
        }
    }

    // Ø¯Ø± ØªØ§Ø¨Ø¹ addMessageToDOM

    msgDiv.innerHTML = `
        ${(isSent && !msg.isTemp) ? `
        <div class="dropdown position-absolute top-0 start-0 me-1 mt-1">
            <button class="btn btn-sm dropdown-toggle p-0 px-2" type="button" data-bs-toggle="dropdown"></button>
            <ul class="dropdown-menu" style="background: var(--black-color);">
                <li><button class="dropdown-item text-primary" onclick="enableEdit('${msg.id}', '${encodeURIComponent(msg.content)}')">ÙˆÛŒØ±Ø§ÛŒØ´</button></li>
                <li><form method="POST" action="/delete_message/${msg.id}" onsubmit="return confirm('Ø­Ø°Ù Ù¾ÛŒØ§Ù…ØŸ')"><button type="submit" class="dropdown-item text-danger">Ø­Ø°Ù</button></form></li>
            </ul>
        </div>` : ''}
    
        <div id="msg-text-${msg.id}">
            ${msg.content}
            ${fileHtml}
            <div class="message-meta">
                <span>${msg.timestamp}</span>
                ${isSent ? `<span class="status-icon">${statusIconHtml}</span>` : ''}
            </div>
        </div>
    
        ${isSent ? `
        <form id="edit-form-${msg.id}" method="POST" action="/edit_message_inline/${msg.id}" class="d-none">
            <textarea name="content" class="form-control mb-2">${msg.content}</textarea>
            <button type="submit" class="btn btn-sm btn-success">Ø°Ø®ÛŒØ±Ù‡</button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit('${msg.id}')">Ù„ØºÙˆ</button>
        </form>` : ''}
    `;
    // <<<< Ù¾Ø§ÛŒØ§Ù† Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ 2 >>>>
    
    chat.appendChild(msgDiv);
    if (!msg.isTemp) {
        shownMessageIds.add(msg.id);
    }
}
    </script>

<script>
    document.querySelectorAll(".message").forEach(div => {
        const id = parseInt(div.id.replace("message-", ""));
        shownMessageIds.add(id);
    });
</script>
<script>
    let lastMessageId = {{ messages[-1].id if messages else 0 }};
    
    setInterval(async () => {
        const res = await fetch(`/get_new_messages?conversation_id={{ conversation.id }}&after_id=${lastMessageId}`);
        if (!res.ok) return;
    
        const data = await res.json();
        data.forEach(msg => {
            addMessageToDOM(msg);
            lastMessageId = msg.id;
        });
        scrollToBottom();
    }, 5000);
    </script>
    
    <script>
    let lastMessageId = {{ messages[-1].id if messages else 0 }};
    
    setInterval(async () => {
        const res = await fetch(`/get_new_messages?conversation_id={{ conversation.id }}&after_id=${lastMessageId}`);
        if (!res.ok) return;
    
        const data = await res.json();
        data.forEach(msg => {
            addMessageToDOM(msg);
            lastMessageId = msg.id;
        });
        scrollToBottom();
    }, 5000);
    </script>
    <!-- <script>
    function setChatHeight() {
        const innerHeight = window.innerHeight;
        const chatBox = document.querySelector('.chat-box');
        if (chatBox) {
            chatBox.style.height = (innerHeight - 100) + 'px'; // Ù…Ù‚Ø¯Ø§Ø± 100 Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…Ù‡ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø¯Ø± ÛŒØ§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§)
            chatBox.style.overflowY = 'auto';
        }
    }

    window.addEventListener('load', setChatHeight);
    window.addEventListener('resize', setChatHeight);
</script>
<script>
function setChatBoxHeight() {
  let height = window.innerHeight;
  if (window.visualViewport) {
    height = window.visualViewport.height;
  }
  const chatBox = document.querySelector('.chat-box');
  if (chatBox) {
    chatBox.style.height = `${height - 100}px`;
    chatBox.style.overflowY = 'auto';
  }
}

window.addEventListener('load', setChatBoxHeight);
window.addEventListener('resize', setChatBoxHeight);
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', setChatBoxHeight);
}
</script> -->
    <!-- <script>
        let startY = 0;
        let isPulling = false;
        let spinner = document.getElementById("pull-spinner");
        
        window.addEventListener("touchstart", function (e) {
            if (window.scrollY === 0) {
                startY = e.touches[0].clientY;
                isPulling = true;
            }
        });
        
        window.addEventListener("touchmove", function (e) {
            if (!isPulling) return;
        
            let currentY = e.touches[0].clientY;
            let diffY = currentY - startY;
        
            if (diffY > 30 && diffY < 130) {
                spinner.style.top = `${diffY - 60}px`; // Ø§Ø³Ù¾ÛŒÙ†Ø± Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            }
        
            if (diffY >= 130) {
                spinner.style.top = `150px`; // Ø§Ø³Ù¾ÛŒÙ†Ø± Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ù†Ù…Ø§ÛŒØ§Ù† Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
                if (!spinner.dataset.loading) {  // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú†Ù†Ø¯Ø¨Ø§Ø± Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù† Ø±ÙØ±Ø´
                    spinner.dataset.loading = "true";
                    location.reload(); // Ø±ÙØ±Ø´ ØµÙØ­Ù‡
                }
                isPulling = false;
            }
        });
        
        window.addEventListener("touchend", function () {
            // Ø§Ú¯Ø± Ø±ÙØ±Ø´ Ú©Ø§Ù…Ù„ Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ Ø§Ø³Ù¾ÛŒÙ†Ø± Ø±Ùˆ Ù¾Ù†Ù‡Ø§Ù† Ú©Ù†
            if (!spinner.dataset.loading) {
                spinner.style.top = `-60px`; 
            }
            isPulling = false;
        });
        
        // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡
        window.addEventListener("load", function () {
            // ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ú©Ø§Ù…Ù„Ø§ Ù„ÙˆØ¯ Ø´Ø¯ØŒ Ø§Ø³Ù¾ÛŒÙ†Ø± Ø±Ùˆ Ù¾Ù†Ù‡Ø§Ù† Ú©Ù† Ø¨Ø§Ù„Ø§
            spinner.style.top = `-60px`; 
            spinner.dataset.loading = ""; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ù„ÙˆØ¯ÛŒÙ†Ú¯
        });
        </script> -->
</body>
</html>
